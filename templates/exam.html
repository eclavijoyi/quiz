<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Simulacro de Examen</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .question {
        margin-bottom: 20px;
      }
      .timer {
        font-weight: bold;
        font-size: 1.2em;
        color: red;
        margin-bottom: 20px;
      }
      .result {
        font-size: 1.2em;
        margin-top: 20px;
      }
      .error-list {
        margin-top: 20px;
      }
      .error-item {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <h1>Simulacro de Examen (Capítulos 1 al 4)</h1>

    <!-- Temporizador -->
    <div class="timer">Tiempo restante: <span id="timer">03:30:00</span></div>

    {% if not submitted %}
    <!-- FORMULARIO DE EXAMEN -->
    <form method="POST" id="examForm">
      {% for q in questions %}
      <div class="question">
        <p><strong>Pregunta {{ q.number }}:</strong> {{ q.question }}</p>
        {% for key, value in q.options.items() %}
        <label>
          <input
            type="radio"
            name="{{ q.number }}"
            value="{{ key }}"
            required
          />
          ({{ key.upper() }}) {{ value }} </label
        ><br />
        {% endfor %}
      </div>
      {% endfor %}
      <button type="submit">Enviar Respuestas</button>
    </form>

    {% else %}
    <!-- RESULTADOS -->
    <div class="result">
      <p><strong>Has contestado todas las preguntas.</strong></p>
      <p>Puntaje obtenido: {{ score }}/{{ total }}</p>
      {% if passed %}
      <p style="color: green">¡Felicidades, has aprobado!</p>
      {% else %}
      <p style="color: red">Lo sentimos, no has aprobado.</p>
      {% endif %}
    </div>

    <!-- Listado de preguntas erradas -->
    {% if errors %}
    <div class="error-list">
      <h2>Preguntas contestadas erróneamente:</h2>
      <ul>
        {% for error in errors %}
        <li class="error-item">
          <strong>Pregunta {{ error.number }}:</strong> {{ error.question }}<br />
          <em>Respuesta correcta:</em> ({{ error.correct_answer_key | upper }})
          {{ error.correct_answer_text }}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %} {% endif %}

    <!-- Script de Timer (3h 30m = 12600 seg) -->
    <script>
      let totalTime = {{ 3*60*60 + 30*60 }};
      let timerDisplay = document.getElementById('timer');
      let examForm = document.getElementById('examForm');

      function formatTime(seconds) {
        let hrs = Math.floor(seconds / 3600);
        let mins = Math.floor((seconds % 3600) / 60);
        let secs = seconds % 60;
        let hrsStr = hrs < 10 ? "0" + hrs : hrs;
        let minsStr = mins < 10 ? "0" + mins : mins;
        let secsStr = secs < 10 ? "0" + secs : secs;
        return hrsStr + ":" + minsStr + ":" + secsStr;
      }

      let countdown = setInterval(function(){
        totalTime--;
        timerDisplay.textContent = formatTime(totalTime);
        if (totalTime <= 0) {
          clearInterval(countdown);
          examForm.submit();
        }
      }, 1000);
    </script>
  </body>
</html>
